<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="AI æ™ºæ…§æ·±è¹²æª¢æ¸¬ - é€éæ‰‹æ©Ÿé¡é ­åˆ†ææ‚¨çš„ä¸‹è‚¢è‚ŒåŠ›å¥åº·ã€‚">
  <meta name="keywords" content="æ·±è¹², è‚Œå°‘ç—‡, AI, æª¢æ¸¬, å¾©å¥">
  <title>Smart Squat Demo - 5æ¬¡åç«™æ¸¬è©¦</title>
  <style>
    body { margin: 0; background-color: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; -webkit-tap-highlight-color: transparent; }
    canvas { position: absolute; max-width: 100%; max-height: 100%; }
    video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

    /* æ‰‹æ©Ÿï¼šå½±ç‰‡/ç•«å¸ƒæ»¿ç‰ˆ */
    @media (max-width: 768px) {
      canvas { width: 100% !important; height: 100% !important; max-width: none; max-height: none; object-fit: cover; }
    }

    /* å³ä¸Šè§’ï¼šåˆ‡æ›é¡é ­ + éœéŸ³ */
    #btnSwitchCamera,
    #btnMute {
      position: absolute; top: 16px; z-index: 160;
      width: 56px; height: 56px; border-radius: 50%;
      background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.5);
      font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      padding: 0; line-height: 1;
    }
    #btnSwitchCamera { right: 80px; }
    #btnMute { right: 16px; }
    #btnSwitchCamera:hover,
    #btnMute:hover { background: rgba(0,0,0,0.8); }
    #btnSwitchCamera:active,
    #btnMute:active { transform: scale(0.95); }

    /* å…¨è¢å¹•é®ç½© */
    .overlay {
      position: absolute; inset: 0; display: flex; justify-content: center; align-items: center;
      background: rgba(0,0,0,0.5); z-index: 150;
      pointer-events: none;
      opacity: 0;
    }
    .overlay.active { pointer-events: auto; opacity: 1; }

    /* æ•™å­¸å¼•å°é  */
    #tutorialCard {
      display: flex; flex-direction: column; align-items: center; gap: clamp(20px, 5vw, 28px);
      background: rgba(0,0,0,0.75); padding: clamp(28px, 6vw, 40px) clamp(24px, 6vw, 40px);
      border-radius: 24px; border: 2px solid rgba(255,255,255,0.2);
      max-width: 92%; max-height: 90vh; overflow-y: auto;
    }
    #tutorialCard h2 {
      color: #fff; font-size: clamp(22px, 5vw, 28px); margin: 0; text-align: center;
    }
    .tutorial-steps {
      display: flex; flex-direction: column; gap: clamp(14px, 3vw, 20px);
      color: rgba(255,255,255,0.95); font-size: clamp(16px, 4vw, 20px);
      line-height: 1.5; text-align: left; width: 100%;
    }
    .tutorial-steps .step { display: flex; align-items: flex-start; gap: 12px; }
    .tutorial-steps .step .emoji { font-size: 1.3em; flex-shrink: 0; }
    #btnTutorialOk {
      padding: clamp(20px, 5vw, 28px) clamp(36px, 8vw, 52px);
      font-size: clamp(20px, 4.5vw, 26px); font-weight: bold; color: #000; background: #00ff88;
      border: none; border-radius: 16px; cursor: pointer;
      transition: transform 0.1s, background 0.2s; margin-top: 8px;
    }
    #btnTutorialOk:hover { background: #33ffaa; transform: scale(1.02); }
    #btnTutorialOk:active { transform: scale(0.98); }

    /* æ­¡è¿é ï¼šå—æ¸¬è€…è³‡æ–™è¡¨å–® */
    .welcome-form {
      display: flex; flex-direction: column; align-items: center; gap: clamp(20px, 5vw, 28px);
      width: 100%; max-width: 400px; padding: 0 24px;
    }
    .welcome-form label { display: block; color: rgba(255,255,255,0.9); font-size: clamp(18px, 4vw, 22px); margin-bottom: 8px; }
    .welcome-form input {
      width: 100%; padding: clamp(16px, 4vw, 22px) clamp(20px, 5vw, 28px);
      font-size: clamp(22px, 5vw, 28px); color: #fff; background: rgba(0,0,0,0.6);
      border: 2px solid rgba(255,255,255,0.3); border-radius: 14px;
      box-sizing: border-box;
    }
    .welcome-form input::placeholder { color: rgba(255,255,255,0.5); }
    .welcome-form input:focus { outline: none; border-color: #00ff88; }

    /* [ é–‹å§‹æ¸¬é©— ] å¤§æŒ‰éˆ•ï¼ˆæ‰‹æ©Ÿæ›´å¤§ï¼‰ */
    #btnStart {
      padding: clamp(24px, 6vw, 36px) clamp(48px, 12vw, 72px);
      font-size: clamp(28px, 7vw, 40px); font-weight: bold; color: #000; background: #00ff88;
      border: none; border-radius: 20px; cursor: pointer; box-shadow: 0 8px 24px rgba(0,255,136,0.4);
      transition: transform 0.1s, background 0.2s;
      min-height: 64px;
    }
    #btnStart:hover:not(:disabled) { background: #33ffaa; transform: scale(1.02); }
    #btnStart:active:not(:disabled) { transform: scale(0.98); }
    #btnStart:disabled { opacity: 0.6; cursor: not-allowed; }

    /* å€’æ•¸æ•¸å­— */
    #countdownNum {
      font-size: clamp(80px, 25vw, 140px); font-weight: bold; color: #fff;
      text-shadow: 0 0 40px rgba(0,255,136,0.8);
      display: none;
    }

    /* ç·´ç¿’æ¨¡å¼é ‚éƒ¨ç‹€æ…‹åˆ—ï¼ˆè—è‰²é†’ç›®ï¼‰ */
    #practiceBanner {
      position: absolute; top: clamp(16px, 4vw, 24px); left: 50%; transform: translateX(-50%);
      color: #4fc3f7; font-size: clamp(18px, 4vw, 24px); font-weight: bold;
      background: rgba(0,0,0,0.8); padding: clamp(12px, 3vw, 18px) clamp(24px, 5vw, 36px);
      border-radius: 16px; z-index: 100; text-align: center; white-space: nowrap;
    }

    /* ç·´ç¿’å®Œæˆè¦†è“‹ï¼ˆç¶ è‰²å‹¾å‹¾ï¼‰ */
    #practiceCompleteOverlay {
      position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: rgba(0,0,0,0.7); z-index: 155; pointer-events: none;
    }
    #practiceCompleteOverlay .checkText { color: #00ff88; font-size: clamp(32px, 8vw, 48px); font-weight: bold; margin-top: 16px; }

    /* è¨ˆæ•¸å™¨ + è¨ˆæ™‚ */
    #counter {
      position: absolute; top: clamp(16px, 4vw, 24px); left: clamp(16px, 4vw, 24px);
      color: #fff; font-family: sans-serif; font-size: clamp(36px, 8vw, 52px); font-weight: bold;
      background: rgba(0,0,0,0.7); padding: clamp(12px, 3vw, 20px) clamp(20px, 4vw, 28px); border-radius: 16px;
      z-index: 100; line-height: 1.2;
    }
    #counter span { color: #00ff88; }

    #timer {
      position: absolute; top: clamp(16px, 4vw, 24px); right: clamp(16px, 4vw, 24px);
      color: #00ff88; font-family: monospace; font-size: clamp(28px, 6vw, 40px); font-weight: bold;
      background: rgba(0,0,0,0.7); padding: clamp(12px, 3vw, 18px) clamp(18px, 4vw, 24px); border-radius: 16px;
      z-index: 100;
    }

    /* ç‹€æ…‹æç¤º */
    #stateText {
      position: absolute; top: 18%; left: 50%; transform: translateX(-50%);
      color: #fff; font-family: sans-serif; font-size: clamp(28px, 6vw, 42px); font-weight: bold;
      background: rgba(0,0,0,0.65); padding: clamp(16px, 4vw, 24px) clamp(24px, 6vw, 44px); border-radius: 20px;
      z-index: 100; text-align: center; white-space: nowrap;
    }

    #angleDebug {
      position: absolute; bottom: clamp(16px, 4vw, 24px); left: 50%; transform: translateX(-50%);
      color: #aaa; font-family: monospace; font-size: clamp(14px, 3.5vw, 20px);
      background: rgba(0,0,0,0.6); padding: 8px 16px; border-radius: 10px;
      z-index: 100;
    }

    /* ä¿¡å¿ƒåº¦ä¸è¶³æ™‚çš„ä¸­é–“é»ƒè‰²æç¤º */
    #lowConfidenceHint {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: #ffc107; font-size: clamp(18px, 4vw, 24px); font-weight: bold;
      background: rgba(0,0,0,0.75); padding: 16px 24px; border-radius: 16px;
      z-index: 100; text-align: center;
    }

    /* çµæœå¡ç‰‡ */
    #resultCard {
      display: none;
      flex-direction: column; align-items: center; gap: clamp(16px, 4vw, 28px);
      background: rgba(0,0,0,0.85); padding: clamp(32px, 8vw, 52px) clamp(40px, 10vw, 60px); border-radius: 24px;
      border: 2px solid #00ff88; box-shadow: 0 0 40px rgba(0,255,136,0.2);
      max-width: 92%;
    }
    #resultCard.show { display: flex; }
    #resultCard h2 { color: #fff; font-size: clamp(24px, 6vw, 32px); margin: 0 0 8px 0; }
    #resultCard .time { color: #00ff88; font-size: clamp(32px, 8vw, 48px); font-weight: bold; margin: 8px 0; }
    #resultCard .comment { color: #ddd; font-size: clamp(20px, 5vw, 28px); margin: 12px 0; }
    #uploadStatus { color: #aaa; font-size: clamp(16px, 4vw, 20px); margin-top: 4px; min-height: 1.5em; }
    #btnRetry {
      padding: clamp(20px, 5vw, 28px) clamp(40px, 10vw, 52px);
      font-size: clamp(24px, 6vw, 32px); font-weight: bold; color: #000; background: #00ff88;
      border: none; border-radius: 16px; cursor: pointer; margin-top: 8px;
      transition: transform 0.1s, background 0.2s;
    }
    #btnRetry:hover { background: #33ffaa; transform: scale(1.02); }
    #btnRetry:active { transform: scale(0.98); }

    #status {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      color: white; font-family: sans-serif; font-size: clamp(18px, 4vw, 22px); font-weight: bold;
      background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px;
      z-index: 101; text-align: center;
    }
    #status.hidden { display: none; }

    .hidden { display: none !important; }

    /* é å°¾ï¼šéš±ç§æ¬Šé€£çµ */
    #footerPrivacy {
      position: fixed; bottom: 10px; left: 0; right: 0; text-align: center; z-index: 170;
    }
    #footerPrivacy a {
      color: rgba(255,255,255,0.7); font-size: 12px; text-decoration: none;
    }
    #footerPrivacy a:hover { text-decoration: underline; color: rgba(255,255,255,0.9); }

    /* éš±ç§æ¬Š Modal */
    #privacyModalOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 300;
      display: none; justify-content: center; align-items: center; padding: 20px;
    }
    #privacyModalOverlay.show { display: flex; }
    #privacyModal {
      background: #1a1a1a; color: #eee; max-width: 420px; width: 100%;
      padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.15);
    }
    #privacyModal h3 { margin: 0 0 16px 0; font-size: 20px; color: #fff; }
    #privacyModal p { margin: 0 0 20px 0; font-size: 15px; line-height: 1.6; }
    #privacyModal .btnClose { width: 100%; padding: 14px; font-size: 16px; font-weight: bold; color: #000; background: #00ff88; border: none; border-radius: 10px; cursor: pointer; }
    #privacyModal .btnClose:hover { background: #33ffaa; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
</head>

<body>
  <button type="button" id="btnSwitchCamera" title="åˆ‡æ›é¡é ­" aria-label="åˆ‡æ›å‰å¾Œé¡é ­">ğŸ”„</button>
  <button type="button" id="btnMute" title="åˆ‡æ›èªéŸ³" aria-label="åˆ‡æ›èªéŸ³">ğŸ”Š</button>
  <div id="status">æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...<br><span style="font-size:14px; font-weight:normal;">è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™</span></div>

  <!-- æ•™å­¸å¼•å°ï¼ˆè¼‰å…¥å¾Œç¬¬ä¸€å€‹é¡¯ç¤ºï¼‰ -->
  <div id="overlayTutorial" class="overlay active">
    <div id="tutorialCard">
      <h2>æ­¡è¿ä½¿ç”¨ 5æ¬¡åç«™æ¸¬é©—</h2>
      <div class="tutorial-steps">
        <div class="step"><span class="emoji">ğŸ“±</span><span>æ­¥é©Ÿ 1ï¼šè«‹å°‡æ‰‹æ©Ÿæ©«æ”¾å›ºå®šæ–¼æ¡Œä¸Šæˆ–æ¶å­ä¸Šã€‚</span></div>
        <div class="step"><span class="emoji">ğŸª‘</span><span>æ­¥é©Ÿ 2ï¼šè«‹åœ¨è·é›¢æ‰‹æ©Ÿç´„ 2~3 å…¬å°ºè™•æº–å‚™ä¸€å¼µæ¤…å­ã€‚</span></div>
        <div class="step"><span class="emoji">ğŸ§</span><span>æ­¥é©Ÿ 3ï¼šç¢ºä¿æ‚¨çš„å…¨èº«ï¼ˆå´é¢è¦–è§’ï¼‰éƒ½åœ¨ç•«é¢ä¸­ã€‚</span></div>
      </div>
      <button type="button" id="btnTutorialOk">ğŸ“· æˆæ¬Šç›¸æ©Ÿä¸¦é–‹å§‹ç·´ç¿’</button>
    </div>
  </div>

  <div id="overlayWelcome" class="overlay">
    <div class="welcome-form">
      <label for="inputName">å§“å / æš±ç¨±</label>
      <input type="text" id="inputName" placeholder="è«‹è¼¸å…¥å§“åæˆ–æš±ç¨±" autocomplete="name" />
      <label for="inputAge">å¹´é½¡</label>
      <input type="number" id="inputAge" placeholder="65" min="1" max="120" value="65" />
      <button type="button" id="btnStart">é–‹å§‹æ¸¬é©—</button>
    </div>
  </div>

  <div id="overlayCountdown" class="overlay">
    <div id="countdownNum"></div>
  </div>

  <div id="practiceBanner" class="hidden">ğŸ”µ ç·´ç¿’æ¨¡å¼ï¼šè«‹è©¦è‘—åš 1 æ¬¡èµ·ç«‹åä¸‹</div>
  <div id="practiceCompleteOverlay" class="hidden"><span style="font-size:80px;">âœ…</span><span class="checkText">ç·´ç¿’å®Œæˆ</span></div>
  <div id="counter" class="hidden">0 / 5</div>
  <div id="timer" class="hidden">0.00 s</div>
  <div id="stateText" class="hidden">è«‹åä¸‹ ğŸª‘</div>
  <div id="angleDebug" class="hidden">è†è“‹è§’åº¦: --Â°</div>
  <div id="lowConfidenceHint" class="hidden" aria-live="polite">âš ï¸ è«‹å›ºå®šæ‰‹æ©Ÿæˆ–é€€å¾Œä¸€é»</div>

  <div id="overlayResult" class="overlay">
    <div id="resultCard">
      <h2>æ¸¬è©¦å®Œæˆ</h2>
      <div class="time" id="resultTime">ç¸½è€—æ™‚ï¼š0.00 ç§’</div>
      <div class="comment" id="resultComment"></div>
      <div id="uploadStatus" aria-live="polite"></div>
      <button type="button" id="btnRetry">å†æ¸¬ä¸€æ¬¡</button>
    </div>
  </div>

  <video id="input_video" playsinline></video>
  <canvas id="output_canvas"></canvas>

  <footer id="footerPrivacy">
    <a href="#" id="linkPrivacy">éš±ç§æ¬Šæ”¿ç­–èˆ‡ä½¿ç”¨æ¢æ¬¾</a>
  </footer>

  <div id="privacyModalOverlay" aria-hidden="true">
    <div id="privacyModal" role="dialog" aria-labelledby="privacyModalTitle">
      <h3 id="privacyModalTitle">éš±ç§æ¬Šè²æ˜</h3>
      <p>æœ¬ç¶²ç«™ç‚ºé–‹æºæ¸¬è©¦å°ˆæ¡ˆã€‚æˆ‘å€‘ä¸æœƒä¸Šå‚³æ‚¨çš„ç›¸æ©Ÿå½±åƒåˆ°ä¼ºæœå™¨ï¼Œæ‰€æœ‰éª¨æ¶é‹ç®—çš†åœ¨æ‚¨çš„æ‰‹æ©Ÿæœ¬æ©Ÿç«¯ (Local) åŸ·è¡Œã€‚åƒ…æœ‰æœ€çµ‚çš„æ¸¬é©—æˆç¸¾ï¼ˆæ¬¡æ•¸ã€å¹´é½¡ï¼‰æœƒä»¥åŒ¿åæ–¹å¼å„²å­˜ä»¥ä¾›çµ±è¨ˆã€‚</p>
      <button type="button" class="btnClose" id="btnPrivacyClose">æˆ‘äº†è§£</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ---------- Firebase è¨­å®šï¼ˆè«‹å¡«å…¥æ‚¨çš„é‡‘é‘°ï¼‰ ----------
    const firebaseConfig = {
        apiKey: "AIzaSyB6wcFs5gSiNDCSweKcEzgRpbIAAb5I3Vo",
        authDomain: "smart-squat-health.firebaseapp.com",
        projectId: "smart-squat-health",
        storageBucket: "smart-squat-health.firebasestorage.app",
        messagingSenderId: "475970550783",
        appId: "1:475970550783:web:2d7dcacb2e55b562eb05ca",
        measurementId: "G-P3YYVH06LB"
    };

    let db = null;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    } catch (e) {
      console.warn('Firebase æœªè¨­å®šæˆ–åˆå§‹åŒ–å¤±æ•—ï¼Œå°‡ç•¥éä¸Šå‚³åŠŸèƒ½ã€‚', e);
    }

    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const statusDiv = document.getElementById('status');
    const counterDiv = document.getElementById('counter');
    const timerDiv = document.getElementById('timer');
    const stateTextDiv = document.getElementById('stateText');
    const angleDebugDiv = document.getElementById('angleDebug');
    const overlayTutorial = document.getElementById('overlayTutorial');
    const overlayWelcome = document.getElementById('overlayWelcome');
    const overlayCountdown = document.getElementById('overlayCountdown');
    const countdownNum = document.getElementById('countdownNum');
    const btnStart = document.getElementById('btnStart');
    const inputName = document.getElementById('inputName');
    const inputAge = document.getElementById('inputAge');
    const overlayResult = document.getElementById('overlayResult');
    const resultCard = document.getElementById('resultCard');
    const resultTime = document.getElementById('resultTime');
    const resultComment = document.getElementById('resultComment');
    const uploadStatus = document.getElementById('uploadStatus');
    const btnRetry = document.getElementById('btnRetry');
    const btnMute = document.getElementById('btnMute');
    const btnSwitchCamera = document.getElementById('btnSwitchCamera');
    const btnTutorialOk = document.getElementById('btnTutorialOk');

    const TARGET_COUNT = 5;
    const ANGLE_SIT = 100;   // æœ‰æ˜é¡¯å½æ›²å³ç®—åä¸‹ï¼ˆæ”¾å¯¬ï¼Œé©æ‡‰å¯¬é¬†è¤²ç­‰ï¼‰
    const ANGLE_STAND = 140; // è…¿æœ‰æ‰“ç›´è¶¨å‹¢å³ç®—ç«™ç«‹ï¼ˆæ”¾å¯¬ï¼Œè§£æ±ºã€Œç«™ç›´åªæœ‰ 140Â°ã€ç„¡æ³•è¨ˆæ•¸ï¼‰
    const COUNTDOWN_SEC = 5;
    const VISIBILITY_MIN = 0.30;      // è‡€/è†/è¸å¯è¦‹åº¦é–€æª»ï¼ˆé™ä½ä»¥æ¸›å°‘è§’åº¦æ¶ˆå¤±ï¼‰
    const SIT_MIN_DURATION_MS = 500;  // åä¸‹è‡³å°‘æŒçºŒ 0.5 ç§’æ‰å…è¨±è¨ˆæ•¸ +1

    const LEFT_HIP = 23, LEFT_KNEE = 25, LEFT_ANKLE = 27;
    const RIGHT_HIP = 24, RIGHT_KNEE = 26, RIGHT_ANKLE = 28;

    let phase = 'welcome';
    let currentState = null;
    let repCount = 0;
    let hasShownReady = false;
    let startTime = null;
    let endTime = null;
    let timerAnimationId = null;
    let isMuted = false;
    let userName = '';
    let userAge = 65;
    let useFrontCamera = true;
    let cameraInstance = null;
    let lastSitTime = null;
    let isPracticeMode = false;
    let practiceTransitioning = false;
    // æ­£å¼æ¸¬é©—ç”¨çš„é€æ¬¡åˆ†æè³‡æ–™
    let repTimestamps = [];   // æ¯ä¸€ä¸‹å®Œæˆæ™‚çš„æ™‚é–“æˆ³ï¼ˆDate.now()ï¼‰
    let repDurations = [];    // æ¯ä¸€ä¸‹è€—æ™‚ï¼ˆç§’ï¼‰
    let repMaxAngles = [];    // æ¯ä¸€ä¸‹éç¨‹ä¸­çš„æœ€å¤§è§’åº¦ï¼ˆç«™ç«‹ï¼‰
    let repMinAngles = [];    // æ¯ä¸€ä¸‹éç¨‹ä¸­çš„æœ€å°è§’åº¦ï¼ˆåä¸‹ï¼‰
    let tempMaxAngle = null;  // ç•¶å‰é€™ä¸€ä¸‹çš„æš«å­˜æœ€å¤§è§’åº¦
    let tempMinAngle = null;  // ç•¶å‰é€™ä¸€ä¸‹çš„æš«å­˜æœ€å°è§’åº¦
    let lastRepTimestamp = null; // ä¸Šä¸€æ¬¡å®Œæˆä¸€ä¸‹æ™‚çš„æ™‚é–“ï¼ˆperformance.nowï¼‰

    function speak(text) {
      if (isMuted || !text || !text.trim()) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text.trim());
      u.lang = 'zh-TW';
      u.rate = 0.95;
      u.volume = 1;
      window.speechSynthesis.speak(u);
    }

    function unlockTTS() {
      if (isMuted) return;
      const u = new SpeechSynthesisUtterance('\u200B');
      u.lang = 'zh-TW';
      u.volume = 0.01;
      window.speechSynthesis.speak(u);
    }

    function updateMuteButton() {
      btnMute.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      btnMute.setAttribute('aria-label', isMuted ? 'é–‹å•ŸèªéŸ³' : 'éœéŸ³');
    }
    btnMute.addEventListener('click', () => {
      isMuted = !isMuted;
      updateMuteButton();
    });
    updateMuteButton();

    function beep() {
      if (isMuted) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.frequency.value = 800;
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.value = 0.3;
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.15);
      } catch (e) {}
    }

    function angleBetweenThreePoints(p1, p2, p3) {
      const v1 = { x: p1.x - p2.x, y: p1.y - p2.y };
      const v2 = { x: p3.x - p2.x, y: p3.y - p2.y };
      const len1 = Math.hypot(v1.x, v1.y);
      const len2 = Math.hypot(v2.x, v2.y);
      if (len1 < 1e-6 || len2 < 1e-6) return null;
      const cos = (v1.x * v2.x + v1.y * v2.y) / (len1 * len2);
      const rad = Math.acos(Math.max(-1, Math.min(1, cos)));
      return (rad * 180 / Math.PI);
    }

    /**
     * å–å¾—è†è“‹è§’åº¦ï¼Œä¸¦æª¢æŸ¥è‡€/è†/è¸ä¸‰é»å¯è¦‹åº¦ã€‚
     * åªæœ‰ä¸‰é» visibility éƒ½ > VISIBILITY_MIN æ™‚ confidenceOk æ‰ç‚º trueï¼Œæ‰å¯ç”¨æ–¼ç‹€æ…‹æ›´æ–°ã€‚
     */
    function getKneeAngle(landmarks) {
      const leftH = landmarks[LEFT_HIP], leftK = landmarks[LEFT_KNEE], leftA = landmarks[LEFT_ANKLE];
      const rightH = landmarks[RIGHT_HIP], rightK = landmarks[RIGHT_KNEE], rightA = landmarks[RIGHT_ANKLE];
      const leftVis = (leftH?.visibility ?? 0) + (leftK?.visibility ?? 0) + (leftA?.visibility ?? 0);
      const rightVis = (rightH?.visibility ?? 0) + (rightK?.visibility ?? 0) + (rightA?.visibility ?? 0);

      const useLeft = leftVis >= rightVis;
      const h = useLeft ? leftH : rightH;
      const k = useLeft ? leftK : rightK;
      const a = useLeft ? leftA : rightA;

      const confidenceOk = (h?.visibility ?? 0) > VISIBILITY_MIN &&
                          (k?.visibility ?? 0) > VISIBILITY_MIN &&
                          (a?.visibility ?? 0) > VISIBILITY_MIN;

      const angle = confidenceOk ? angleBetweenThreePoints(h, k, a) : null;
      return { angle, side: useLeft ? 'left' : 'right', confidenceOk };
    }

    function getComment(seconds) {
      if (seconds < 12) return 'è‚ŒåŠ›å„ªç•° ğŸ’ª';
      if (seconds > 15) return 'è«‹å¤šç•™æ„è…¿éƒ¨è‚ŒåŠ› âš ï¸';
      return 'è¡¨ç¾è‰¯å¥½ ğŸ‘';
    }

    /** ä¸Šå‚³ç”¨è©•èªä»£ç¢¼ */
    function getResultCode(seconds) {
      if (seconds < 12) return 'Excellent';
      if (seconds > 15) return 'NeedImprovement';
      return 'Normal';
    }

    function validateParticipant() {
      const name = (inputName.value || '').trim();
      const ageRaw = inputAge.value;
      const age = ageRaw === '' ? NaN : parseInt(ageRaw, 10);
      if (!name) return { ok: false, msg: 'è«‹è¼¸å…¥å§“åæˆ–æš±ç¨±' };
      if (!Number.isFinite(age) || age < 1 || age > 120) return { ok: false, msg: 'è«‹è¼¸å…¥æœ‰æ•ˆå¹´é½¡ï¼ˆ1â€“120ï¼‰' };
      return { ok: true, name, age };
    }

    function setStartButtonState() {
      const v = validateParticipant();
      btnStart.disabled = !v.ok;
    }
    inputName.addEventListener('input', setStartButtonState);
    inputName.addEventListener('blur', setStartButtonState);
    inputAge.addEventListener('input', setStartButtonState);
    inputAge.addEventListener('blur', setStartButtonState);
    setStartButtonState();

    (function applyUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const nameParam = urlParams.get('name');
      const ageParam = urlParams.get('age');
      let filledName = false;
      let filledAge = false;
      if (nameParam && (nameParam.trim() !== '')) {
        inputName.value = nameParam.trim();
        filledName = true;
      }
      if (ageParam != null && ageParam !== '') {
        const ageNum = parseInt(ageParam, 10);
        if (Number.isFinite(ageNum) && ageNum >= 1 && ageNum <= 120) {
          inputAge.value = String(ageNum);
          filledAge = true;
        }
      }
      if (filledName || filledAge) setStartButtonState();
      if (filledName && filledAge) {
        inputName.disabled = true;
        inputAge.disabled = true;
        setTimeout(function () { btnStart.focus(); }, 100);
      }
    })();

    function startPracticeMode() {
      const v = validateParticipant();
      if (!v.ok) {
        alert(v.msg);
        return;
      }
      userName = v.name;
      userAge = v.age;
      isPracticeMode = true;
      practiceTransitioning = false;
      repCount = 0;
      currentState = null;
      lastSitTime = null;

      phase = 'testing';
      overlayWelcome.classList.remove('active');
      counterDiv.classList.add('hidden');
      timerDiv.classList.add('hidden');
      const practiceBanner = document.getElementById('practiceBanner');
      if (practiceBanner) {
        practiceBanner.classList.remove('hidden');
        practiceBanner.textContent = 'ğŸ”µ ç·´ç¿’æ¨¡å¼ï¼šè«‹è©¦è‘—åš 1 æ¬¡èµ·ç«‹åä¸‹';
      }
      stateTextDiv.classList.remove('hidden');
      angleDebugDiv.classList.remove('hidden');
      document.getElementById('lowConfidenceHint')?.classList.add('hidden');

      speak('ç¾åœ¨æ˜¯ç·´ç¿’æ¨¡å¼ã€‚è«‹é€€å¾Œï¼Œåšä¸€æ¬¡èµ·ç«‹åä¸‹è®“æˆ‘ç¢ºèªã€‚');
    }

    function startCountdown() {
      // æ­£å¼æ¸¬é©—é–‹å§‹å‰ï¼Œé‡ç½®é€æ¬¡åˆ†æè³‡æ–™
      repTimestamps = [];
      repDurations = [];
      repMaxAngles = [];
      repMinAngles = [];
      tempMaxAngle = null;
      tempMinAngle = null;
      lastRepTimestamp = null;

      phase = 'countdown';
      overlayWelcome.classList.remove('active');
      document.getElementById('practiceBanner')?.classList.add('hidden');
      document.getElementById('practiceCompleteOverlay')?.classList.add('hidden');
      overlayCountdown.classList.add('active');
      countdownNum.style.display = 'block';

      unlockTTS();

      let n = COUNTDOWN_SEC;
      countdownNum.textContent = n;
      speak(String(n));
      beep();

      const iv = setInterval(() => {
        n--;
        if (n <= 0) {
          clearInterval(iv);
          speak('é–‹å§‹');
          countdownNum.style.display = 'none';
          overlayCountdown.classList.remove('active');
          phase = 'testing';
          startTime = performance.now();
          endTime = null;
          counterDiv.classList.remove('hidden');
          timerDiv.classList.remove('hidden');
          stateTextDiv.classList.remove('hidden');
          angleDebugDiv.classList.remove('hidden');
          return;
        }
        countdownNum.textContent = n;
        speak(String(n));
        beep();
      }, 1000);
    }

    function updateTimer() {
      if (phase !== 'testing' || startTime == null) return;
      const elapsed = (performance.now() - startTime) / 1000;
      timerDiv.textContent = elapsed.toFixed(2) + ' s';
      timerAnimationId = requestAnimationFrame(updateTimer);
    }

    async function uploadRecord(seconds) {
      if (isPracticeMode) return;
      uploadStatus.textContent = 'â˜ï¸ æ•¸æ“šä¸Šå‚³ä¸­...';
      if (!db) {
        uploadStatus.textContent = '';
        return;
      }
      try {
        await addDoc(collection(db, 'squat_records'), {
          name: userName,
          age: userAge,
          duration: Math.round(seconds * 100) / 100,
          timestamp: serverTimestamp(),
          result: getResultCode(seconds),
          platform: 'Web Demo',
          analysis: {
            rep_durations: repDurations.map((v) => Math.round(v * 100) / 100),
            rep_max_angles: repMaxAngles,
            rep_min_angles: repMinAngles
          }
        });
        uploadStatus.textContent = 'âœ… æ•¸æ“šå·²é›²ç«¯å„²å­˜';
      } catch (err) {
        console.error('ä¸Šå‚³å¤±æ•—', err);
        uploadStatus.textContent = 'âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
      }
    }

    function showResult() {
      if (endTime == null || startTime == null) return;
      const seconds = (endTime - startTime) / 1000;
      phase = 'result';
      if (timerAnimationId != null) {
        cancelAnimationFrame(timerAnimationId);
        timerAnimationId = null;
      }
      counterDiv.classList.add('hidden');
      timerDiv.classList.add('hidden');
      stateTextDiv.classList.add('hidden');
      angleDebugDiv.classList.add('hidden');

      resultTime.textContent = 'ç¸½è€—æ™‚ï¼š' + seconds.toFixed(2) + ' ç§’';
      resultComment.textContent = getComment(seconds);
      uploadStatus.textContent = '';
      overlayResult.classList.add('active');
      resultCard.classList.add('show');

      speak('æ¸¬é©—çµæŸï¼Œç¸½å…±èŠ±è²» ' + seconds.toFixed(1) + ' ç§’');

      uploadRecord(seconds);
    }

    function resetTest() {
      phase = 'welcome';
      currentState = null;
      repCount = 0;
      startTime = null;
      endTime = null;
      lastSitTime = null;
      isPracticeMode = false;
      practiceTransitioning = false;
      if (timerAnimationId != null) {
        cancelAnimationFrame(timerAnimationId);
        timerAnimationId = null;
      }
      overlayResult.classList.remove('active');
      resultCard.classList.remove('show');
      uploadStatus.textContent = '';
      overlayWelcome.classList.add('active');
      document.getElementById('practiceBanner')?.classList.add('hidden');
      document.getElementById('practiceCompleteOverlay')?.classList.add('hidden');
      counterDiv.classList.add('hidden');
      timerDiv.classList.add('hidden');
      stateTextDiv.classList.add('hidden');
      angleDebugDiv.classList.add('hidden');
      document.getElementById('lowConfidenceHint')?.classList.add('hidden');
      timerDiv.textContent = '0.00 s';
      counterDiv.innerHTML = '<span>0</span> / ' + TARGET_COUNT;
      inputName.disabled = false;
      inputAge.disabled = false;
      setStartButtonState();
    }

    function onResults(results) {
      if (!hasShownReady) {
        hasShownReady = true;
        statusDiv.classList.add('hidden');
      }

      canvasElement.width = videoElement.videoWidth;
      canvasElement.height = videoElement.videoHeight;

      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      let kneeAngle = null;
      let kneeInfo = null;
      if (results.poseLandmarks && phase === 'testing') {
        kneeInfo = getKneeAngle(results.poseLandmarks);
        kneeAngle = kneeInfo.confidenceOk ? kneeInfo.angle : null;

        // åªåœ¨æ­£å¼æ¸¬é©—æœŸé–“è¨˜éŒ„é€™ä¸€ä¸‹çš„æœ€å¤§/æœ€å°è§’åº¦
        if (!isPracticeMode && kneeInfo.confidenceOk && kneeAngle != null) {
          if (tempMaxAngle == null || kneeAngle > tempMaxAngle) tempMaxAngle = kneeAngle;
          if (tempMinAngle == null || kneeAngle < tempMinAngle) tempMinAngle = kneeAngle;
        }

        if (kneeInfo.confidenceOk && kneeAngle != null && !practiceTransitioning) {
          let newState = currentState;
          if (kneeAngle < ANGLE_SIT) newState = 'Sit';
          else if (kneeAngle > ANGLE_STAND) newState = 'Stand';

          if (newState !== currentState) {
            if (newState === 'Sit') {
              lastSitTime = performance.now();
              if (isPracticeMode) speak('å¾ˆå¥½ï¼Œè«‹èµ·ç«‹ã€‚');
            }
            if (currentState === 'Sit' && newState === 'Stand') {
              const sitDuration = lastSitTime != null ? performance.now() - lastSitTime : 0;
              if (sitDuration >= SIT_MIN_DURATION_MS) {
                repCount = Math.min(repCount + 1, TARGET_COUNT);

                if (isPracticeMode) {
                  if (repCount >= 1) {
                    practiceTransitioning = true;
                    speak('ç·´ç¿’æˆåŠŸï¼å§¿å‹¢æ­£ç¢ºã€‚3 ç§’å¾Œé–‹å§‹æ­£å¼æ¸¬é©—ã€‚');
                    const overlay = document.getElementById('practiceCompleteOverlay');
                    if (overlay) overlay.classList.remove('hidden');
                    setTimeout(() => {
                      if (overlay) overlay.classList.add('hidden');
                      document.getElementById('practiceBanner')?.classList.add('hidden');
                      isPracticeMode = false;
                      repCount = 0;
                      currentState = null;
                      lastSitTime = null;
                      practiceTransitioning = false;
                      startCountdown();
                    }, 3000);
                  }
                } else {
                  // æ­£å¼æ¸¬é©—ï¼šå®Œæˆä¸€æ¬¡å‹•ä½œæ™‚ï¼Œè¨˜éŒ„é€æ¬¡åˆ†æè³‡æ–™
                  const nowPerf = performance.now();
                  if (startTime != null) {
                    const base = lastRepTimestamp != null ? lastRepTimestamp : startTime;
                    const durSec = (nowPerf - base) / 1000;
                    repDurations.push(Math.round(durSec * 100) / 100);
                  }
                  repTimestamps.push(Date.now());
                  repMaxAngles.push(tempMaxAngle != null ? tempMaxAngle : (kneeAngle ?? null));
                  repMinAngles.push(tempMinAngle != null ? tempMinAngle : (kneeAngle ?? null));
                  lastRepTimestamp = nowPerf;
                  tempMaxAngle = null;
                  tempMinAngle = null;

                  speak(repCount + ' ä¸‹');
                  if (repCount >= TARGET_COUNT) {
                    endTime = performance.now();
                    showResult();
                  }
                }
              }
            }
            currentState = newState;
          }
        }

        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                       { color: '#00FF00', lineWidth: 4 });
        drawLandmarks(canvasCtx, results.poseLandmarks,
                      { color: '#FF0000', lineWidth: 2, radius: 4 });
      } else if (results.poseLandmarks) {
        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                       { color: '#00FF00', lineWidth: 4 });
        drawLandmarks(canvasCtx, results.poseLandmarks,
                      { color: '#FF0000', lineWidth: 2, radius: 4 });
      }

      if (phase === 'testing') {
        const lowConfidenceHint = document.getElementById('lowConfidenceHint');
        const showLowConfidence = !results.poseLandmarks || (kneeInfo && !kneeInfo.confidenceOk);
        if (lowConfidenceHint) {
          if (showLowConfidence) lowConfidenceHint.classList.remove('hidden');
          else lowConfidenceHint.classList.add('hidden');
        }

        if (isPracticeMode) {
          if (document.getElementById('practiceBanner')) document.getElementById('practiceBanner').classList.remove('hidden');
          counterDiv.classList.add('hidden');
          timerDiv.classList.add('hidden');
        } else {
          document.getElementById('practiceBanner')?.classList.add('hidden');
          counterDiv.classList.remove('hidden');
          timerDiv.classList.remove('hidden');
          counterDiv.innerHTML = '<span>' + repCount + '</span> / ' + TARGET_COUNT;
          if (timerAnimationId == null) timerAnimationId = requestAnimationFrame(updateTimer);
        }

        if (repCount >= TARGET_COUNT && !isPracticeMode) {
          // showResult å·²åœ¨ä¸Šæ–¹å‘¼å«
        } else if (currentState === 'Sit') {
          stateTextDiv.textContent = 'è«‹èµ·ç«‹ â¬†ï¸';
        } else if (currentState === 'Stand') {
          stateTextDiv.textContent = 'è«‹åä¸‹ ğŸª‘';
        } else {
          stateTextDiv.textContent = kneeAngle != null ? 'è«‹åä¸‹ ğŸª‘' : 'è«‹è®“å…¨èº«å…¥é¡';
        }
        const angleStr = kneeAngle != null ? kneeAngle.toFixed(1) + 'Â°' : '--Â°';
        let hint = '';
        if (currentState === 'Sit') hint = ' (ç­‰å¾…èµ·ç«‹ > 140Â°)';
        else if (currentState === 'Stand') hint = ' (ç­‰å¾…åä¸‹ < 100Â°)';
        else hint = ' (èµ·ç«‹ > 140Â° / åä¸‹ < 100Â°)';
        angleDebugDiv.textContent = 'è†è“‹è§’åº¦: ' + angleStr + hint;
      }

      canvasCtx.restore();
    }

    btnTutorialOk.addEventListener('click', () => {
      overlayTutorial.classList.remove('active');
      overlayWelcome.classList.add('active');
      startCamera(false);
    });

    btnStart.addEventListener('click', () => {
      if (phase !== 'welcome') return;
      startPracticeMode();
    });

    btnRetry.addEventListener('click', resetTest);

    const pose = new Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });

    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    pose.onResults(onResults);

    /** åœæ­¢ç›®å‰æ”å½±æ©Ÿä¸²æµ */
    function stopCameraStream() {
      if (videoElement.srcObject) {
        videoElement.srcObject.getTracks().forEach((t) => t.stop());
        videoElement.srcObject = null;
      }
    }

    /**
     * å•Ÿå‹•æ”å½±æ©Ÿï¼ˆæˆ–åˆ‡æ›é¡é ­æ™‚é‡æ–°å•Ÿå‹•ï¼‰ã€‚
     * @param {boolean} showSwitchingUI - è‹¥ç‚º trueï¼Œé¡¯ç¤ºã€Œåˆ‡æ›ä¸­...ã€ä¸¦åœ¨ä¸²æµå°±ç·’å¾Œéš±è—
     */
    function startCamera(showSwitchingUI = false) {
      if (showSwitchingUI) {
        statusDiv.classList.remove('hidden');
        statusDiv.textContent = 'åˆ‡æ›ä¸­...';
        videoElement.addEventListener('loadedmetadata', () => {
          statusDiv.classList.add('hidden');
        }, { once: true });
      }

      stopCameraStream();

      cameraInstance = new Camera(videoElement, {
        onFrame: async () => {
          await pose.send({ image: videoElement });
        },
        width: 1280,
        height: 720,
        facingMode: useFrontCamera ? 'user' : 'environment'
      });
      cameraInstance.start();
    }

    btnSwitchCamera.addEventListener('click', () => {
      useFrontCamera = !useFrontCamera;
      startCamera(true);
    });

    const linkPrivacy = document.getElementById('linkPrivacy');
    const privacyModalOverlay = document.getElementById('privacyModalOverlay');
    const btnPrivacyClose = document.getElementById('btnPrivacyClose');
    if (linkPrivacy) {
      linkPrivacy.addEventListener('click', (e) => {
        e.preventDefault();
        if (privacyModalOverlay) {
          privacyModalOverlay.classList.add('show');
          privacyModalOverlay.setAttribute('aria-hidden', 'false');
        }
      });
    }
    if (btnPrivacyClose) {
      btnPrivacyClose.addEventListener('click', () => {
        if (privacyModalOverlay) {
          privacyModalOverlay.classList.remove('show');
          privacyModalOverlay.setAttribute('aria-hidden', 'true');
        }
      });
    }
    if (privacyModalOverlay) {
      privacyModalOverlay.addEventListener('click', (e) => {
        if (e.target === privacyModalOverlay) {
          privacyModalOverlay.classList.remove('show');
          privacyModalOverlay.setAttribute('aria-hidden', 'true');
        }
      });
    }

  </script>
</body>
</html>
